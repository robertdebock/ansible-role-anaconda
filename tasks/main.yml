---
# tasks file for anaconda
- name: include assert.yml
  include_tasks: assert.yml

- name: install requirements (package)
  package:
    name: "{{ item.name }}"
    state: present
  loop: "{{ anaconda_requirements }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - item.type == "package"

- name: install requirements (pip)
  pip:
    name: "{{ item.name }}"
    state: present
  loop: "{{ anaconda_requirements }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - item.type == "pip"

- name: download anaconda
  get_url:
    url: "{{ anaconda_url }}"
    dest: "{{ anaconda_download_dest }}"

- name: install anaconda
  command: bash {{ anaconda_download_dest }}/{{ anaconda_file }} -b -p {{ anaconda_prefix }}
  args:
    creates: "{{ anaconda_prefix }}"

- name: create anaconda service
  import_role:
    name: robertdebock.service

- name: check for domain_can_mmap_files seboolean
  command: getsebool domain_can_mmap_files
  register: anaconda_getsebool_domain_can_mmap_files
  check_mode: no
  changed_when: no
  failed_when: no
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"

- name: modify selinux settings
  seboolean:
    name: domain_can_mmap_files
    state: yes
    persistent: yes
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"
    - anaconda_getsebool_domain_can_mmap_files.rc == 0

- name: start and enable anaconda
  service:
    name: anaconda
    state: started
    enabled: yes
